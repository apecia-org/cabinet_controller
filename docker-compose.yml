version: '3.8'

services:
  cabinet-api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: cabinet-controller-api
    ports:
      - "80:80"
    environment:
      - NODE_ENV=production
      - PORT=80
      - SERIAL_PORT=${SERIAL_PORT:-/dev/ttyUSB1}
      - BAUD_RATE=${BAUD_RATE:-9600}
    # Mount serial device (for Linux/Mac)
    #devices:
    #  - /dev/ttyUSB0:/dev/ttyUSB0
    # For Windows, you might need --device-cgroup-rule or privileged mode
    # privileged: true
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:80/api/v1/health', (r) => { process.exit(r.statusCode === 200 ? 0 : 1); })"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s
    networks:
      - cabinet-network

networks:
  cabinet-network:
    driver: bridge
